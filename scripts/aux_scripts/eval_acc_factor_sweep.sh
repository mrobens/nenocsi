#!/bin/bash
#************************************************************************************
#
# McAERsim-Framework: Network traffic within McAERsim generated by NEST
# Copyright (C) 2022-2023 Forschungszentrum Juelich GmbH, ZEA-2
# Author: Markus Robens <https://www.fz-juelich.de/profile/robens_m>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#
#************************************************************************************
#
# This shell script parses text files that contain aggregated statistics generated
# by McAERsim with respect to maximum latencies and appends individual results along
# with the respective acceleration factor to a new text file.
#
# Note: This script needs to receive McAERsim's binary directory as first parameter,
#       the network topology as second parameter and the network dimensions as third
#       parameter
#
#       For the calculation of the received/ideal event ratio it is assumed that all
#       events can be transfered for an acceleration factor of 1, because there is a
#       guard interval in the McAERsim simulation to enable this
#
#************************************************************************************
cd $1
echo "# Abbreviations used in this file" > "data/delay_vs_acc_$2_$3_256_npn_MC.txt"
echo "# acc:   acceleration factor" >> "data/delay_vs_acc_$2_$3_256_npn_MC.txt"
echo "# delay: maximum delay" >> "data/delay_vs_acc_$2_$3_256_npn_MC.txt"
echo "# ratio: received/ideal event ratio" >> "data/delay_vs_acc_$2_$3_256_npn_MC.txt"
echo acc$'\t'delay$'\t'ratio >> "data/delay_vs_acc_$2_$3_256_npn_MC.txt"
for ACC in 1 2 5 10 20 50 100 200 500
do
    REFNAME="data/$2_$3_256_npn_MC_acc_001.txt"
    printf -v IFNAME "data/$2_$3_256_npn_MC_acc_%03d.txt" $ACC
    EVTS_RECEIVED=$(( $(cat $IFNAME | sed '/^% Total received events:/ !d; s/^% Total received events: \([0-9]*\)$/\1/')-$(cat $IFNAME | sed '/^% Locally delivered events:/ !d; s/^% Locally delivered events: \([0-9]*\)$/\1/') ))
    EVTS_EXPECTED=$(( $(cat $REFNAME | sed '/^% Total received events:/ !d; s/^% Total received events: \([0-9]*\)$/\1/')-$(cat $REFNAME | sed '/^% Locally delivered events:/ !d; s/^% Locally delivered events: \([0-9]*\)$/\1/') ))
    echo ${ACC}$'\t'$(cat $IFNAME | sed '/^% Maximum delay (cycles):/ ! d; s/^% Maximum delay (cycles): \([0-9.+e]*\)$/\1/')\
	$'\t'$(( $EVTS_RECEIVED / $EVTS_EXPECTED )) >> "data/delay_vs_acc_$2_$3_256_npn_MC.txt"
done
